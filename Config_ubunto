#!/bin/bash

# --- VARIABLES (Ajustadas a tus rutas) ---
R_PATH="/home/frontend1/Escritorio/Base-a-medias-main"
APP_NAME="NUAM"
CERT="$R_PATH/localhost+2.crt"
KEY="$R_PATH/localhost+2.key"

echo "--- Iniciando Configuración en Modo PROXY (Tipo Windows) ---"

# 1. Instalar dependencias necesarias
sudo apt update && sudo apt install -y apache2

# 2. Activar módulos de Apache para Proxy y SSL
# Esto permite que Apache redireccione el tráfico al puerto 8000
sudo a2enmod ssl proxy proxy_http rewrite headers

# 3. Crear el VirtualHost en modo Proxy
# Nota: Quitamos mod_wsgi para usar la terminal de Django directamente
sudo bash -c "cat << EOF > /etc/apache2/sites-available/django_ssl.conf
<VirtualHost *:443>
    ServerName localhost

    SSLEngine on
    SSLCertificateFile $CERT
    SSLCertificateKeyFile $KEY

    # Configuración de Proxy idéntica a tu Windows
    ProxyPreserveHost On
    ProxyRequests Off
    RequestHeader set X-Forwarded-Proto \"https\"

    # Servir archivos estáticos directamente desde Apache
    Alias /static $R_PATH/staticfiles
    <Directory $R_PATH/staticfiles>
        Require all granted
    </Directory>

    # No pasar los estáticos al proxy, que los maneje Apache
    ProxyPass /static/ !

    # Enviar todo lo demás al servidor de desarrollo (Terminal)
    ProxyPass / http://127.0.0.1:8000/
    ProxyPassReverse / http://127.0.0.1:8000/

    ErrorLog \${APACHE_LOG_DIR}/django_error.log
    CustomLog \${APACHE_LOG_DIR}/django_access.log combined
</VirtualHost>
EOF"

# 4. Activar sitio y desactivar el default
sudo a2ensite django_ssl.conf
sudo a2dissite 000-default.conf

# 5. Permisos de paso para Apache
chmod +x /home/frontend1
chmod +x /home/frontend1/Escritorio

# 6. Reiniciar Apache
echo "--- Verificando configuración y reiniciando Apache ---"
sudo apache2ctl configtest && sudo systemctl restart apache2

echo "--------------------------------------------------------"
echo "PROCESO FINALIZADO CON ÉXITO"
echo "--------------------------------------------------------"
echo "PARA VER LOS GET/POST, DEBES HACER LO SIGUIENTE:"
echo "1. Abre una terminal nueva."
echo "2. Ejecuta: cd $R_PATH"
echo "3. Ejecuta: source env/bin/activate"
echo "4. Ejecuta: python manage.py runserver"
echo "5. Entra a https://localhost en tu navegador."
echo "--------------------------------------------------------"
# 6. Reiniciar
sudo apache2ctl configtest && sudo systemctl restart apache2
echo "--- Proceso finalizado. Prueba entrar a https://localhost ---"



SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
CSRF_TRUSTED_ORIGINS = ['https://localhost']
