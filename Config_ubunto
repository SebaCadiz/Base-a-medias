#!/bin/bash

# --- VARIABLES (Ajustadas a tus rutas) ---
R_PATH="/home/frontend1/Escritorio/Base-a-medias-main"
APP_NAME="NUAM" 
CERT="$R_PATH/localhost+2.crt"
KEY="$R_PATH/localhost+2.key"

echo "--- Iniciando Configuración en Modo PROXY (Tipo Windows) ---"

# 1. Instalar dependencias necesarias
sudo apt update && sudo apt install -y apache2

# 2. Activar módulos de Apache para Proxy y SSL
# Necesitamos proxy_http para redirigir el tráfico y ssl para el certificado
sudo a2enmod ssl proxy proxy_http rewrite headers

# 3. Crear el VirtualHost en modo Proxy
# Esta configuración permite que Apache reciba HTTPS y hable con Django
sudo bash -c "cat << EOF > /etc/apache2/sites-available/django_ssl.conf
<VirtualHost *:443>
    ServerName localhost

    SSLEngine on
    SSLCertificateFile $CERT
    SSLCertificateKeyFile $KEY

    # Soporte para que Apache pueda hablar con un Django que también tiene SSL
    SSLProxyEngine On
    SSLProxyVerify none 
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerExpire off

    # Configuración de Proxy idéntica a tu Windows
    ProxyPreserveHost On
    ProxyRequests Off
    RequestHeader set X-Forwarded-Proto \"https\"

    # Servir archivos estáticos directamente desde Apache para mayor velocidad
    Alias /static $R_PATH/staticfiles
    <Directory $R_PATH/staticfiles>
        Require all granted
    </Directory>

    # No pasar los estáticos al proxy, que los maneje Apache
    ProxyPass /static/ !

    # Enviar todo lo demás al servidor de desarrollo (Terminal)
    # Si usas runserver normal, cambia https por http abajo
    ProxyPass / https://127.0.0.1:8000/
    ProxyPassReverse / https://127.0.0.1:8000/

    ErrorLog \${APACHE_LOG_DIR}/django_error.log
    CustomLog \${APACHE_LOG_DIR}/django_access.log combined
</VirtualHost>
EOF"

# 4. Activar sitio y desactivar el default para evitar conflictos
sudo a2ensite django_ssl.conf
sudo a2dissite 000-default.conf

# 5. Permisos de paso para Apache (necesario para acceder a /static)
chmod +x /home/frontend1
chmod +x /home/frontend1/Escritorio

# 6. Reiniciar Apache
echo "--- Verificando configuración y reiniciando Apache ---"
sudo apache2ctl configtest && sudo systemctl restart apache2

echo "--------------------------------------------------------"
echo "PROCESO FINALIZADO"
echo "--------------------------------------------------------"
echo "PASOS PARA VER TU LOGIN Y LOS GET/POST:"
echo "1. Ve a tu terminal de Django."
echo "2. Ejecuta: python manage.py runserver_plus --cert-file localhost+2.pem"
echo "3. Entra en el navegador a: https://localhost"
echo "--------------------------------------------------------"

SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
CSRF_TRUSTED_ORIGINS = ['https://localhost']
