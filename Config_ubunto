#!/bin/bash

# --- VARIABLES (Ajustadas a tus fotos) ---
R_PATH="/home/frontend1/Escritorio/Base-a-medias-main"
APP_NAME="NUAM" 
CERT="$R_PATH/localhost+2.crt"
KEY="$R_PATH/localhost+2.key"
# Buscamos el m칩dulo compilado autom치ticamente
WSGI_MOD=$(find $R_PATH/env -name "mod_wsgi-py*.so" | head -n 1)

echo "--- Iniciando Configuraci칩n ---"

# 1. Instalar dependencias para compilar mod_wsgi
sudo apt update && sudo apt install -y apache2-dev python3-dev

# 2. Intentar instalar mod_wsgi de nuevo (ahora funcionar치)
source $R_PATH/env/bin/activate
pip install mod_wsgi

# 3. Configurar Apache
sudo a2enmod ssl rewrite
echo "LoadModule wsgi_module $WSGI_MOD" | sudo tee /etc/apache2/mods-available/wsgi_custom.load
sudo a2enmod wsgi_custom

# 4. Crear el VirtualHost
sudo bash -c "cat << EOF > /etc/apache2/sites-available/django_ssl.conf
<VirtualHost *:443>
    ServerName localhost
    SSLEngine on
    SSLCertificateFile $CERT
    SSLCertificateKeyFile $KEY

    WSGIDaemonProcess django_app python-home=$R_PATH/env python-path=$R_PATH
    WSGIProcessGroup django_app
    WSGIScriptAlias / $R_PATH/$APP_NAME/wsgi.py

    Alias /static $R_PATH/staticfiles
    <Directory $R_PATH/staticfiles>
        Require all granted
    </Directory>

    <Directory $R_PATH/$APP_NAME>
        <Files wsgi.py>
            Require all granted
        </Files>
    </Directory>
</VirtualHost>
EOF"

# 5. Activar y dar permisos de paso a Apache
sudo a2ensite django_ssl.conf
sudo a2dissite 000-default.conf
chmod +x /home/frontend1
chmod +x /home/frontend1/Escritorio

# 6. Reiniciar
sudo apache2ctl configtest && sudo systemctl restart apache2
echo "--- Proceso finalizado. Prueba entrar a https://localhost ---"
