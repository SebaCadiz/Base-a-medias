{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertidor de Divisas | NUAM</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="{% static 'divisa.css' %}">
    <link rel="stylesheet" href="{% static 'index.css' %}">
</head>
<body>
    <header class="main-header">
        <nav class="nav-links">
            <a href="{% url 'index' %}" class="nav-link">‚Üê Volver al Inicio</a>
        </nav>
        <div class="user-session">
            <span class="session-text">Sesi√≥n:</span>
            <span class="username">{{ usuario.nombre }} {{ usuario.apellido }}</span>
            
            <form action="{% url 'logout' %}" method="POST" style="margin: 0;">
                {% csrf_token %}
                <button type="submit" class="btn-logout">CERRAR</button>
            </form>
        </div>
    </header>

    <div class="top-banner"></div>

    <main class="container">
        <h1 class="main-title">Convertidor de Divisas</h1>

        <section class="converter-section">
            <div class="converter-box">
                <h2>Conversi√≥n de Monedas en Vivo</h2>

                <div class="converter">
                    <label for="from">Desde:</label>
                    <select id="from">
                        <option value="EUR">EUR - Euro</option>
                        <option value="USD" >USD - D√≥lar EE.UU.</option>
                        <option value="CLP">CLP - Peso Chileno</option>
                        <option value="COP">COP - Peso colombiano</option>
                        <option value="PEN">PEN - Sol peruano</option>
                    </select>

                    <label for="to">Hacia:</label>
                    <select id="to">
                        <option value="EUR">EUR - Euro</option>
                        <option value="USD">USD - D√≥lar EE.UU.</option>
                        <option value="CLP" >CLP - Peso Chileno</option>
                        <option value="COP">COP - Peso colombiano</option>
                        <option value="PEN">PEN - Sol peruano</option>
                    </select>

                    <label for="amount">Monto: Ej:10,100,1.000</label>
                    <input type="number" id="amount" placeholder="100" value="100">

                    <button onclick="convert()">Convertir</button>

                    <div id="loading" style="display:none">Convirtiendo...</div>
                    <div id="result"></div>
                    <div id="rate"></div>
                </div>
            </div>
        </section>
        
        <section class="dashboard-section">
            <h2 class="section-subtitle">üìà Dashboard: Valores Recientes</h2>
            <p class="section-text">
                Visualizaci√≥n de las tendencias de las monedas regionales (COP, CLP, PEN).
            </p>
            <div class="chart-container-grid"> 
                <div class="chart-box">
                    <h3>CLP vs. USD</h3>
                    <canvas id="clpChart"></canvas>
                </div>
                <div class="chart-box">
                    <h3>COP vs. USD</h3>
                    <canvas id="copChart"></canvas>
                </div>
                <div class="chart-box">
                    <h3>PEN vs. USD</h3>
                    <canvas id="penChart"></canvas>
                </div>
            </div>
            <div id="chart-loading" style="display:none; text-align: center; margin-top: 20px;">Cargando datos para gr√°ficos...</div>
        </section>
        <section id="quienes-somos" class="quienes-somos">
            <h2 class="section-subtitle">¬øPor qu√© usar NUAM?</h2>
            <p class="section-text">
                Nuestro convertidor de divisas en vivo te proporciona tasas de cambio actualizadas en tiempo real, permiti√©ndote tomar decisiones financieras informadas para tus operaciones tributarias internacionales.
            </p>
            <p class="section-text">
                Integrado con nuestro sistema de gesti√≥n tributaria, puedes realizar conversiones r√°pidas y precisas sin salir de la plataforma.
            </p>
        </section>  
    </main>

    <script>
        // Funci√≥n de Conversi√≥n (Existente)
        async function convert() {
            const from = document.getElementById("from").value;
            const to = document.getElementById("to").value;
            const amount = document.getElementById("amount").value;

            if (!amount || amount <= 0) {
                document.getElementById("result").innerText = "Ingresa un monto v√°lido.";
                return;
            }

            if (from === to) {
                document.getElementById("result").innerText = "Las monedas no pueden ser iguales.";
                return;
            }

            const url = `/api/convert/?from_currency=${from}&to_currency=${to}&amount=${amount}`;

            document.getElementById("loading").style.display = "block";
            document.getElementById("result").innerText = "";
            document.getElementById("rate").innerText = "";

            try {
                const response = await fetch(url);
                const data = await response.json();

                document.getElementById("loading").style.display = "none";

                if (data.error) {
                    document.getElementById("result").innerText = "Error: " + data.error;
                    return;
                }

                const formatted = Number(data.resultado).toLocaleString("es-CL", {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });

                document.getElementById("result").innerText =
                    `${amount} ${from} = ${formatted} ${to}`;

                document.getElementById("rate").innerText =
                    `Tasa utilizada: 1 ${from} = ${data.rate} ${to}`;

            } catch (error) {
                document.getElementById("loading").style.display = "none";
                document.getElementById("result").innerText = "Error al conectar con la API.";
            }
        }
        
        // =========================================================
        // L√≥gica de Gr√°ficos (Dashboard)
        // =========================================================
        
        async function initCharts() {
            // Endpoint que debe estar configurado en tu urls.py de Django
            const chartUrl = '/api/chartdata/'; 
            const loadingElement = document.getElementById("chart-loading");
            loadingElement.style.display = "block";

            try {
                const response = await fetch(chartUrl);
                const data = await response.json();
                loadingElement.style.display = "none";
                
                if (data.error || data.result !== 'success') {
                    console.error("Error al obtener datos de gr√°ficos:", data.error || "Fallo en la respuesta.");
                    return;
                }

                // El backend env√≠a [D-6, ..., Hoy]. Chart.js espera [D-6, ..., Hoy]
                // Si el backend env√≠a [Hoy, ..., D-6], hay que invertir. Asumiendo la primera opci√≥n:
                const dates = data.data.dates; 
                const series = data.data.series;
                
                
                function createChart(canvasId, label, dataSet, color) {
                    new Chart(document.getElementById(canvasId), {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [{
                                label: label,
                                data: dataSet, 
                                borderColor: color,
                                backgroundColor: color.replace('rgb', 'rgba').replace(')', ', 0.2)'),
                                tension: 0.2, 
                                fill: true,
                                pointRadius: 3
                            }]
                        },
                        options: {
                            responsive: true,
                            // CLAVE para que no se expanda y respete el tama√±o del div contenedor
                            maintainAspectRatio: false, 
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    ticks: {
                                        callback: function(value) {
                                            // Formato localizado para el eje Y
                                            return value.toLocaleString('es-CL', { maximumFractionDigits: 4 });
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

                const colors = {
                    clp: 'rgb(54, 162, 235)', // Azul
                    cop: 'rgb(255, 99, 132)', // Rojo
                    pen: 'rgb(75, 192, 192)', // Verde/Cian
                };

                // Creaci√≥n de los 3 gr√°ficos
                createChart('clpChart', 'CLP vs USD', series.CLP_vs_USD, colors.clp);
                createChart('copChart', 'COP vs USD', series.COP_vs_USD, colors.cop);
                createChart('penChart', 'PEN vs USD', series.PEN_vs_USD, colors.pen);
                
            } catch (error) {
                loadingElement.style.display = "none";
                console.error("Error al conectar con la API para gr√°ficos:", error);
            }
        }
        
        // Ejecutar la funci√≥n de gr√°ficos al cargar la p√°gina
        window.onload = function() {
            initCharts();
        };
    </script>
</body>
</html>